<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãƒãƒ£ãƒƒãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-green-50 text-gray-800">
    <div class="max-w-4xl mx-auto p-6">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-gray-700">ğŸ¤– AIãƒãƒ£ãƒƒãƒˆ</h1>
            <div class="flex items-center gap-2">
                {% if current_user %}
                <span class="text-xs text-gray-500">ğŸ‘¤ {{ current_user }}</span>
                {% endif %}
                <a href="/" class="text-sm text-blue-600 hover:underline">æˆ»ã‚‹</a>
            </div>
        </div>

        <div id="chat-box" class="bg-white border border-gray-200 rounded-lg p-4 h-[60vh] overflow-y-auto space-y-3"></div>

        <div class="mt-4 flex items-center gap-2">
            <textarea id="chat-input" rows="2" class="flex-1 border border-gray-200 rounded p-2 focus:ring-2 focus:ring-blue-200 focus:border-transparent" placeholder="è³ªå•ã‚’å…¥åŠ›..." ></textarea>
            <button id="chat-send" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">é€ä¿¡</button>
        </div>
        <div class="mt-2 text-xs text-gray-400">ãƒãƒ¼ãƒˆæ–‡è„ˆã‚’å‚ç…§ã—ã¦å›ç­”ã—ã¾ã™ã€‚</div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');

        const saved = localStorage.getItem('aiChatHistory');
        let messages = saved ? JSON.parse(saved) : [
            { role: 'assistant', content: 'ã“ã‚“ã«ã¡ã¯ã€‚ä½•ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ã‹ï¼Ÿ' }
        ];

        function renderMessages() {
            chatBox.innerHTML = '';
            messages.forEach(msg => {
                const row = document.createElement('div');
                row.className = msg.role === 'user' ? 'text-right' : 'text-left';
                const bubble = document.createElement('div');
                bubble.className = msg.role === 'user'
                    ? 'inline-block bg-blue-500 text-white px-3 py-2 rounded-lg max-w-[80%] whitespace-pre-wrap'
                    : 'inline-block bg-gray-100 text-gray-800 px-3 py-2 rounded-lg max-w-[80%] whitespace-pre-wrap';
                bubble.textContent = msg.content;
                row.appendChild(bubble);
                chatBox.appendChild(row);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const text = (chatInput.value || '').trim();
            if (!text) return;
            messages.push({ role: 'user', content: text });
            chatInput.value = '';
            renderMessages();
            localStorage.setItem('aiChatHistory', JSON.stringify(messages));

            try {
                const res = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages })
                });
                const data = await res.json();
                if (!res.ok) {
                    messages.push({ role: 'assistant', content: data.error || 'AIå¿œç­”ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' });
                } else {
                    messages.push({ role: 'assistant', content: data.answer || 'å›ç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚' });
                }
            } catch (e) {
                messages.push({ role: 'assistant', content: 'AIå¿œç­”ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' });
            }

            renderMessages();
            localStorage.setItem('aiChatHistory', JSON.stringify(messages));
        }

        chatSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        renderMessages();
    </script>
</body>
</html>
