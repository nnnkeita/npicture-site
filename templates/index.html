<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiroku journalè¨˜éŒ²é›‘èªŒ</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2965/2965358.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-child { margin-left: 20px; border-left: 1px solid #e5e7eb; }
        .page-item { user-select: none; }
        .page-item:hover { background-color: #f3f4f6; }
        .page-item[draggable="true"] { cursor: move; }
        .drop-before { box-shadow: inset 0 2px 0 #60a5fa; }
        .drop-after { box-shadow: inset 0 -2px 0 #60a5fa; }
        .drop-into { background-color: #dbeafe; }
        html.dark .drop-before { box-shadow: inset 0 2px 0 #3b82f6; }
        html.dark .drop-after { box-shadow: inset 0 -2px 0 #3b82f6; }
        html.dark .drop-into { background-color: #1e3a8a; }
        .active-page { background-color: #e5e7eb; font-weight: 500; }
        .selected-page { background-color: #dbeafe; }
        #context-menu { position: absolute; z-index: 50; display: none; background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 6px; min-width: 160px; }
        .menu-item { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; font-size: 14px; color: #374151; }
        .menu-item:hover { background-color: #f3f4f6; }
        .drag-handle { cursor: grab; color: #d1d5db; display: flex; align-items: center; justify-content: center; width: 20px; opacity: 0; }
        .block-row:hover .drag-handle { opacity: 1; }
        html.dark .block-row:hover { background-color: #1f2937; }
        .cover-image-container { height: 20vh; min-height: 150px; background-color: #f9fafb; position: relative; display: none; background-size: cover; background-position: center; }

        /* --- Dark Mode Overrides --- */
        html.dark body { background-color: #0f172a; color: #e5e7eb; }
        html.dark #sidebar { background-color: #0b1220; border-color: #374151; }
        html.dark #main-container { background-color: #0f172a; }
        html.dark .page-item:hover { background-color: #1f2937; }
        html.dark .active-page { background-color: #374151; }
        html.dark #context-menu { background: #111827; border-color: #374151; }
        html.dark .menu-item { color: #d1d5db; }
        html.dark .menu-item:hover { background-color: #1f2937; }
        html.dark .selected-page { background-color: #164e3f; }
        html.dark .cover-image-container { background-color: #0b1220; }
        html.dark .border-gray-200 { border-color: #374151 !important; }
        html.dark .bg-white { background-color: #111827 !important; }
        html.dark .bg-gray-50 { background-color: #0b1220 !important; }
        html.dark .bg-green-50 { background-color: #0b1f1a !important; }
        html.dark .text-gray-600 { color: #d1d5db !important; }
        html.dark .text-gray-500 { color: #cbd5e1 !important; }
        html.dark .text-gray-400 { color: #9ca3af !important; }
        html.dark input, html.dark textarea { color: #e5e7eb; background-color: transparent; }

        /* PCç”¨ï¼ˆ768pxä»¥ä¸Šï¼‰ */
        body { display: flex; height: 100vh; overflow-y: auto; }
        #sidebar { width: 256px; flex-shrink: 0; display: flex; flex-direction: column; border-right: 1px solid #e5e7eb; background-color: #f9fafb; }
        #main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #sidebar-toggle { display: none; }
        #sidebar-overlay { display: none; }
        
        /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼ˆ768pxæœªæº€ï¼‰ */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { position: fixed; left: 0; top: 0; width: 100%; max-width: 300px; height: 100vh; z-index: 50; transform: translateX(-100%); transition: transform 0.3s ease; border-right: none; }
            #sidebar.active { transform: translateX(0); }
            #sidebar-toggle { display: block; }
            #sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 40; }
            #sidebar-overlay.active { display: block; }
            #main-container { width: 100%; }
        }
    </style>
</head>
<body class="bg-green-50 text-gray-800" onclick="hideContextMenu()">

    <div class="w-72 bg-gray-50 border-r border-gray-200 flex flex-col h-full flex-shrink-0" id="sidebar">
        <div class="p-4 flex justify-between items-center">
            <h1 class="font-bold text-gray-600 truncate">Kiroku journalè¨˜éŒ²é›‘èªŒ</h1>
            <button onclick="openSearch()" class="text-gray-400 hover:text-gray-600" title="æ¤œç´¢">ğŸ”</button>
        </div>
        
        <div class="px-4 py-2 border-b border-gray-200">
            <div class="flex justify-between items-center mb-2">
                <button onclick="changeMonth(-1)" class="text-gray-400 hover:text-gray-600 text-xs">â—€</button>
                <span id="calendar-header" class="text-xs font-bold text-gray-600"></span>
                <button onclick="changeMonth(1)" class="text-gray-400 hover:text-gray-600 text-xs">â–¶</button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-xs text-gray-400 mb-1">
                <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>

        <div class="flex-1 overflow-y-auto px-2 py-2 space-y-0.5" id="page-list" oncontextmenu="handleSidebarRightClick(event, null)">
        </div>

        <div class="px-2 py-2 border-t border-gray-200 space-y-1">
            <a href="/inbox" class="w-full text-left px-3 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded flex items-center gap-2 bg-blue-50 cursor-pointer">
                <span>ğŸ”–</span> ã‚ã¨ã§èª¿ã¹ã‚‹
            </a>
            <a href="/finished" class="w-full text-left px-3 py-2 text-sm font-medium text-purple-600 hover:bg-purple-50 rounded flex items-center gap-2 bg-purple-50 cursor-pointer">
                <span>ğŸ“š</span> èª­äº†
            </a>
        </div>

        <div class="p-2 border-t border-gray-200 space-y-1">
            <button onclick="createPage()" class="w-full text-left px-3 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded flex items-center">
                <span class="mr-2">+</span> ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ 
            </button>
            <button onclick="createFolder()" class="w-full text-left px-3 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded flex items-center">
                <span class="mr-2">ğŸ“</span> ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¿½åŠ 
            </button>
            <button onclick="showTemplateMenu()" class="w-full text-left px-3 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded flex items-center">
                <span class="mr-2">â­</span> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
            </button>
            <a href="/chat" class="w-full text-left px-3 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded flex items-center">
                <span class="mr-2">ğŸ¤–</span> AIãƒãƒ£ãƒƒãƒˆ
            </a>
            <button onclick="showExportImportMenu()" class="w-full text-left px-3 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded flex items-center">
                <span class="mr-2">ğŸ’¾</span> ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
            
            <a href="/tanita/login" target="_blank" class="w-full text-left px-3 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded flex items-center">
                <span class="mr-2">âš–ï¸</span> ã‚¿ãƒ‹ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
            </a>
            <button onclick="showTrash()" class="w-full text-left px-3 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded flex items-center">
                <span class="mr-2">ğŸ—‘ï¸</span> ã‚´ãƒŸç®±
            </button>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="main-container" class="flex-1 flex flex-col h-full overflow-hidden relative">
        <div class="h-10 border-b border-gray-200 flex items-center px-4 justify-between bg-white z-10 shrink-0 gap-2">
            <button id="sidebar-toggle" onclick="toggleSidebar()" class="text-gray-600 text-xl">â˜°</button>
            <div class="flex items-center text-sm text-gray-600 flex-1">
                <span id="breadcrumb" class="flex items-center gap-1"></span>
            </div>
            <button id="theme-toggle" onclick="toggleTheme()" class="text-gray-600 text-sm px-2 py-1 rounded hover:bg-gray-100">ğŸŒ™</button>
            <div class="flex items-center gap-2">
                {% if current_user %}
                <span class="text-xs text-gray-500">ğŸ‘¤ {{ current_user }}</span>
                {% endif %}
                <a href="/logout" class="text-xs text-gray-500 hover:text-gray-700 px-2 py-1 rounded hover:bg-gray-100">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            </div>
            <span id="save-status" class="text-xs text-gray-400">ä¿å­˜æ¸ˆã¿</span>
        </div>

        <div class="flex-1 overflow-y-auto bg-green-50" id="editor-container">
            <div id="cover-image" class="cover-image-container group">
                <div class="absolute bottom-2 right-2 add-cover-btn">
                    <button onclick="triggerCoverUpload()" class="bg-white/80 hover:bg-white text-xs px-2 py-1 rounded shadow text-gray-600">ç”»åƒã‚’å¤‰æ›´</button>
                    <button onclick="removeCover()" class="bg-white/80 hover:bg-white text-xs px-2 py-1 rounded shadow text-red-500 ml-1">å‰Šé™¤</button>
                </div>
            </div>

            <div class="max-w-3xl mx-auto p-12 pb-32">
                <div class="group relative mb-4 flex items-end gap-4">
                    <div class="w-16 h-16 flex items-center justify-center text-5xl cursor-pointer hover:bg-gray-100 rounded transition" onclick="updateIcon()">
                        <span id="page-icon">ğŸ“„</span>
                    </div>
                    <button id="add-cover-trigger" onclick="triggerCoverUpload()" class="mb-2 text-sm text-gray-400 hover:text-gray-600 add-cover-btn hidden">ğŸ–¼ï¸ ã‚«ãƒãƒ¼ã‚’è¿½åŠ </button>
                </div>
                
                <input type="text" id="page-title" class="text-4xl font-bold w-full border-none focus:ring-0 placeholder-gray-300 mb-4 bg-transparent cursor-text" placeholder="ç„¡é¡Œ" oninput="saveTitle()">
                
                <div id="blocks" class="space-y-1 pb-10"></div>
                
                <div class="mt-4 text-gray-300 hover:text-gray-500 cursor-pointer text-sm p-2 group">
                    <button onclick="toggleBlockMenu()" class="flex items-center gap-2">
                        + ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ 
                    </button>
                    <div id="block-type-menu" class="hidden mt-2 bg-white rounded shadow-lg border border-gray-200 p-2 space-y-1 absolute z-10">
                        <button onmousedown="event.preventDefault(); addBlock('text'); hideBlockMenu();" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆ</button>
                        <button onmousedown="event.preventDefault(); addBlock('h1'); hideBlockMenu();" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">ğŸ“Œ è¦‹å‡ºã—</button>
                        <button onmousedown="event.preventDefault(); addBlock('todo'); hideBlockMenu();" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">â˜‘ï¸ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</button>
                        <button onmousedown="event.preventDefault(); addBlock('calorie'); hideBlockMenu();" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">ğŸ½ï¸ ã‚«ãƒ­ãƒªãƒ¼</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="cover-upload" class="hidden" accept="image/*" onchange="uploadCover(this)">
    <script>
        let currentPageId = null;
        let saveQueue = new Map();
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebar-overlay').classList.toggle('active');
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchPages();
            renderCalendar();
        });

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½
        function renderCalendar() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            document.getElementById('calendar-header').innerText = `${year}å¹´ ${month + 1}æœˆ`;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            for(let d=1; d<=daysInMonth; d++) {
                const div = document.createElement('div');
                div.className = 'text-center py-1 hover:bg-gray-100 rounded cursor-pointer';
                div.innerText = d;
                div.onclick = () => createPageFromDate(year, month + 1, d);
                grid.appendChild(div);
            }
        }

        async function createPageFromDate(year, month, day) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const res = await fetch('/api/pages/from-date', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ date: dateStr })
            });
            const page = await res.json();
            await fetchPages();
            loadPage(page.id);
        }

        async function fetchPages() {
            const res = await fetch('/api/pages');
            const pages = await res.json();
            const container = document.getElementById('page-list');
            container.innerHTML = '';
            renderTree(pages, container);
        }

        function renderTree(pages, container) {
            pages.forEach(page => {
                const div = document.createElement('div');
                div.className = `px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded cursor-pointer flex items-center ${currentPageId === page.id ? 'bg-gray-200 font-medium' : ''}`;
                div.innerHTML = `<span class="mr-2">${page.icon}</span><span class="truncate">${page.title || 'ç„¡é¡Œ'}</span>`;
                div.onclick = () => loadPage(page.id);
                container.appendChild(div);
                if (page.children) {
                    const childContainer = document.createElement('div');
                    childContainer.className = 'nav-child ml-4 border-l border-gray-200 pl-2';
                    renderTree(page.children, childContainer);
                    container.appendChild(childContainer);
                }
            });
        }

        async function loadPage(id) {
            currentPageId = id;
            const res = await fetch(`/api/pages/${id}`);
            const page = await res.json();
            document.getElementById('page-icon').innerText = page.icon;
            document.getElementById('page-title').value = page.title;
            const blocksContainer = document.getElementById('blocks');
            blocksContainer.innerHTML = '';
            (page.blocks || []).sort((a,b)=>a.position-b.position).forEach(block => renderBlock(block));
            fetchPages(); // Highlight active page
        }

        function renderBlock(block) {
            const container = document.getElementById('blocks');
            const div = document.createElement('div');
            div.className = 'group flex items-start gap-2 py-1';
            div.dataset.id = block.id;
            
            let contentHtml = '';
            if (block.type === 'h1') {
                contentHtml = `<input class="text-3xl font-bold w-full border-none focus:ring-0 bg-transparent" value="${block.content}" oninput="updateBlock(${block.id}, 'content', this.value)">`;
            } else if (block.type === 'todo') {
                contentHtml = `<input type="checkbox" ${block.checked ? 'checked' : ''} class="mt-1.5"><input class="flex-1 border-none focus:ring-0 bg-transparent" value="${block.content}" oninput="updateBlock(${block.id}, 'content', this.value)">`;
            } else if (block.type === 'calorie') {
                // Parse props JSON
                let props = {};
                try {
                    props = typeof block.props === 'string' ? JSON.parse(block.props) : block.props;
                } catch(e) {
                    console.error('Failed to parse calorie props:', e);
                }
                
                const titleHtml = props.title ? `<div class="font-bold text-green-700 mb-2">${props.title}</div>` : '';
                const totalKcalHtml = props.total_kcal ? `<div class="text-sm text-green-600 font-semibold mb-2">åˆè¨ˆ: ${props.total_kcal} kcal</div>` : '';
                const itemsHtml = props.items && Array.isArray(props.items) ? 
                    `<div class="text-sm text-gray-600 space-y-1">${
                        props.items.map(item => {
                            const mark = item.source === 'web' ? 'ï¼ˆwebï¼‰' : (item.is_estimated ? 'ï¼ˆæ¨å®šï¼‰' : '');
                            return `<div>â€¢ ${item.input}: ${item.kcal} kcal ${mark}</div>`;
                        }).join('')
                    }</div>` : '';
                
                contentHtml = `
                    <div class="w-full border border-green-200 rounded-lg p-3 bg-green-50 hover:bg-green-100 transition" data-block-id="${block.id}">
                        ${titleHtml}
                        ${totalKcalHtml}
                        ${itemsHtml || '<div class="text-sm text-gray-400">ã‚«ãƒ­ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã—</div>'}
                        <button onclick="renderCalorieRows(${block.id})" class="mt-2 text-xs text-green-600 hover:text-green-800 underline">ç·¨é›†</button>
                    </div>
                `;
            } else {
                contentHtml = `<textarea class="w-full border-none focus:ring-0 bg-transparent resize-none" rows="1" oninput="updateBlock(${block.id}, 'content', this.value); this.style.height='auto';this.style.height=this.scrollHeight+'px'">${block.content || ''}</textarea>`;
            }
            
            div.innerHTML = `<div class="text-gray-300 opacity-0 group-hover:opacity-100 cursor-grab">â‹®â‹®</div>${contentHtml}`;
            container.appendChild(div);
        }

        function toggleBlockMenu() {
            document.getElementById('block-type-menu').classList.toggle('hidden');
        }
        function hideBlockMenu() {
            document.getElementById('block-type-menu').classList.add('hidden');
        }

        async function addBlock(type) {
            if (!currentPageId) return;
            await fetch(`/api/pages/${currentPageId}/blocks`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type })
            });
            loadPage(currentPageId);
        }

        function updateBlock(id, key, value) {
            // Debounce save
            const k = `block-${id}`;
            if (saveQueue.has(k)) clearTimeout(saveQueue.get(k));
            saveQueue.set(k, setTimeout(async () => {
                const body = {}; body[key] = value;
                await fetch(`/api/blocks/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                document.getElementById('save-status').innerText = 'ä¿å­˜æ¸ˆã¿';
            }, 800));
            document.getElementById('save-status').innerText = 'ä¿å­˜ä¸­...';
        }

        function saveTitle() {
            const val = document.getElementById('page-title').value;
            const k = `title-${currentPageId}`;
            if (saveQueue.has(k)) clearTimeout(saveQueue.get(k));
            saveQueue.set(k, setTimeout(async () => {
                await fetch(`/api/pages/${currentPageId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ title: val })
                });
                fetchPages();
                document.getElementById('save-status').innerText = 'ä¿å­˜æ¸ˆã¿';
            }, 800));
            document.getElementById('save-status').innerText = 'ä¿å­˜ä¸­...';
        }

        async function createPage() {
            const res = await fetch('/api/pages', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ title: 'ç„¡é¡Œ' }) });
            const page = await res.json();
            loadPage(page.id);
        }
    </script>
</body>
</html>