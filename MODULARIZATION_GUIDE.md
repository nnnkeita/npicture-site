# ã‚³ãƒ¼ãƒ‰åˆ†å‰²ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã‚¬ã‚¤ãƒ‰

## ğŸ“Š åˆ†å‰²çµæœ

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆï¼ˆå…¨ 1,669 è¡Œï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œæ•° | å½¹å‰² |
|---------|-----|------|
| **flask_app.py** | **81è¡Œ** | FlaskåˆæœŸåŒ–ã€ãƒšãƒ¼ã‚¸ãƒ«ãƒ¼ãƒˆã€APIç™»éŒ² |
| database.py | 170è¡Œ | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ»ç®¡ç† |
| utils.py | 332è¡Œ | ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° |
| routes.py | 1,086è¡Œ | APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©ï¼ˆ40+ãƒ«ãƒ¼ãƒˆï¼‰ |

### å‰Šæ¸›æˆæœ

```
å…ƒã®æ§‹æˆ: flask_app.py: 1,407è¡Œ
æ–°ã—ã„æ§‹æˆ:
  - flask_app.py: 81è¡Œ ï¼ˆ94% å‰Šæ¸›ï¼ï¼‰
  - routes.py: 1,086è¡Œ
  - database.py: 170è¡Œ
  - utils.py: 332è¡Œ
```

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### Flask ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆflask_app.py - 81è¡Œï¼‰

**è²¬å‹™:**
- Flask ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
- é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è¨­å®š
- ãƒ™ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ãƒ«ãƒ¼ãƒˆï¼ˆ`/`, `/inbox`, `/uploads/<filename>`)
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
- API ãƒ«ãƒ¼ãƒˆã®ç™»éŒ²

```python
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€ 
flask_app.py
â”œâ”€â”€ imports & ãƒ‘ã‚¹è¨­å®š
â”œâ”€â”€ Flask ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
â”œâ”€â”€ ãƒšãƒ¼ã‚¸ãƒ«ãƒ¼ãƒˆï¼ˆ3ã¤ï¼‰
â”œâ”€â”€ register_routes(app) ã§ APIãƒ«ãƒ¼ãƒˆç™»éŒ²
â””â”€â”€ if __name__ == '__main__': èµ·å‹•å‡¦ç†
```

---

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤ï¼ˆdatabase.py - 170è¡Œï¼‰

**è²¬å‹™:**
- DBæ¥ç¶šç®¡ç† (`get_db()`, Flask g ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½¿ç”¨)
- ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ– (`init_db()`)
- ãƒšãƒ¼ã‚¸ä½ç½®è¨ˆç®— (`get_next_position()`, `get_block_next_position()`)
- ãƒ„ãƒªãƒ¼æ“ä½œ (`mark_tree_deleted()`, `hard_delete_tree()`)
- ç‰¹æ®Šãƒšãƒ¼ã‚¸ç®¡ç† (`get_or_create_inbox()`)

**æœ€é©åŒ–:**
- WAL ãƒ¢ãƒ¼ãƒ‰ (journal_mode=WAL)
- åŒæœŸãƒ¢ãƒ¼ãƒ‰ (synchronous=NORMAL)
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºæœ€å¤§åŒ–
- FTS5 ä»®æƒ³ãƒ†ãƒ¼ãƒ–ãƒ«

---

### ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å±¤ï¼ˆutils.py - 332è¡Œï¼‰

**è²¬å‹™:**
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (`allowed_file()`)
- ã‚«ãƒ­ãƒªãƒ¼è¨ˆç®— (`estimate_calories()`)
- ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (`export_page_to_dict()`, `page_to_markdown()`)
- ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (`create_page_from_dict()`)
- ãƒšãƒ¼ã‚¸ã‚³ãƒ”ãƒ¼ (`copy_page_tree()`)
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— (`backup_database_to_json()`)

---

### API ãƒ«ãƒ¼ãƒˆå±¤ï¼ˆroutes.py - 1,086è¡Œï¼‰

**è²¬å‚™:**
- 40+ ã® Flask ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
- ãƒšãƒ¼ã‚¸æ“ä½œ: CRUDã€ãƒ„ãƒªãƒ¼æ“ä½œã€ã‚´ãƒŸç®±
- ãƒ–ãƒ­ãƒƒã‚¯æ“ä½œ: CRUDã€æ¤œç´¢
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†: ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤
- ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ: JSONã€Markdownã€ZIP
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã‚«ãƒ­ãƒªãƒ¼è¨ˆç®—
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒã€Webhook

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ†é¡:**

| æ©Ÿèƒ½ | ä¸»è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
|-----|-----------------|
| ãƒšãƒ¼ã‚¸æ“ä½œ | `/api/pages`, `/api/pages/<id>`, `/api/pages/<id>/copy`, `/api/trash`, `/api/today-highlights/<id>` |
| ãƒ–ãƒ­ãƒƒã‚¯æ“ä½œ | `/api/pages/<id>/blocks`, `/api/blocks/<id>` |
| ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ | `/api/templates`, `/api/pages/from-template`, `/api/pages/from-date` |
| ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | `/api/export/{all/pages}/{json/markdown/zip}`, `/api/import/{json/zip}` |
| ãƒ•ã‚¡ã‚¤ãƒ« | `/api/upload`, `/api/calc-calories` |
| ç®¡ç† | `/download_db`, `/list_backups`, `/restore_backup/<name>`, `/upload_db` |
| Webhook | `/webhook_deploy` |

---

## ğŸ“¦ ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ§‹æˆ

```
flask_app.py
â”œâ”€â”€ from database import
â”‚   â”œâ”€â”€ init_db
â”‚   â””â”€â”€ get_or_create_inbox
â”œâ”€â”€ from routes import
â”‚   â””â”€â”€ register_routes(app)
â””â”€â”€ [Flask, render_template, send_from_directory]

routes.py
â”œâ”€â”€ from database import
â”‚   â”œâ”€â”€ get_db
â”‚   â”œâ”€â”€ get_next_position
â”‚   â”œâ”€â”€ get_block_next_position
â”‚   â”œâ”€â”€ mark_tree_deleted
â”‚   â””â”€â”€ hard_delete_tree
â”œâ”€â”€ from utils import
â”‚   â”œâ”€â”€ allowed_file
â”‚   â”œâ”€â”€ estimate_calories
â”‚   â”œâ”€â”€ export_page_to_dict
â”‚   â”œâ”€â”€ page_to_markdown
â”‚   â”œâ”€â”€ create_page_from_dict
â”‚   â”œâ”€â”€ copy_page_tree
â”‚   â””â”€â”€ backup_database_to_json
â””â”€â”€ [Flask request, jsonify, send_file, ...]

database.py
â”œâ”€â”€ import sqlite3
â”œâ”€â”€ from flask import g
â””â”€â”€ [datetime, etc.]

utils.py
â”œâ”€â”€ import sqlite3, json, io, zipfile, shutil, subprocess
â”œâ”€â”€ from datetime import datetime, timedelta
â””â”€â”€ [werkzeug, requests, etc.]
```

---

## âœ… ãƒ†ã‚¹ãƒˆæ¸ˆã¿æ©Ÿèƒ½

- âœ… ãƒšãƒ¼ã‚¸ä¸€è¦§å–å¾—: `/api/pages`
- âœ… ãƒšãƒ¼ã‚¸è©³ç´°å–å¾—: `/api/pages/<id>`
- âœ… ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸è¡¨ç¤º: `/`
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ: å…¨æ­£å¸¸å‹•ä½œ
- âœ… API ãƒ¬ã‚¹ãƒãƒ³ã‚¹: JSONå½¢å¼ã§æ­£å¸¸å¿œç­”
- âœ… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: å…¨ã¦æ­£å¸¸

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### èµ·å‹•

```bash
python flask_app.py
```

### ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚»ã‚¹

- ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸: `http://localhost:5000/`
- ã‚ã¨ã§èª¿ã¹ã‚‹: `http://localhost:5000/inbox`
- API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‚ç…§

---

## ğŸ“ ç¶­æŒç®¡ç†ã‚¬ã‚¤ãƒ‰

### æ–°ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ æ™‚

1. **routes.py** ã« `@app.route()` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ 
2. `register_routes(app)` å†…ã«å®šç¾©
3. å¿…è¦ãªã‚‰ utils.py/database.py ã«è£œåŠ©é–¢æ•°ã‚’è¿½åŠ 

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°è¿½åŠ æ™‚

1. **database.py** ã«é–¢æ•°ã‚’å®šç¾©
2. `from database import ...` ã§ routes.py ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

### ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°è¿½åŠ æ™‚

1. **utils.py** ã«é–¢æ•°ã‚’å®šç¾©
2. `from utils import ...` ã§ routes.py ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

---

## ğŸ¯ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

- **WAL ãƒ¢ãƒ¼ãƒ‰**: `journal_mode=WAL` â†’ ãƒ©ã‚¤ã‚¿ãƒ»ãƒªãƒ¼ãƒ€ãƒ¼ä¸¦è¡Œå‡¦ç†
- **åŒæœŸå‰Šé™¤**: `synchronous=NORMAL` â†’ åŒæœŸãƒ¢ãƒ¼ãƒ‰å‰Šæ¸›
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: `cache_size=-64000` â†’ ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥64MB
- **ä¸€æ™‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: `temp_store=MEMORY` â†’ ãƒ¡ãƒ¢ãƒªä¸Šã®ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- ãƒšãƒ¼ã‚¸ãƒ†ãƒ¼ãƒ–ãƒ«: `parent_id`, `is_deleted`, `is_pinned`, `created_at`
- ãƒ–ãƒ­ãƒƒã‚¯ãƒ†ãƒ¼ãƒ–ãƒ«: `page_id`, `created_at`
- FTS5 ä»®æƒ³ãƒ†ãƒ¼ãƒ–ãƒ«: å…¨æ–‡æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

---

## âœ¨ ä»Šå¾Œã®æ”¹å–„ææ¡ˆ

1. **ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°å±¤**: Redis/Memcached ã§ API ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
2. **éåŒæœŸå‡¦ç†**: Celery ã§ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’éåŒæœŸåŒ–
3. **å‹ãƒ’ãƒ³ãƒˆ**: Python å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆPEP 484ï¼‰
4. **ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ**: pytest ã§ ãƒ¦ãƒ‹ãƒƒãƒˆ/çµ±åˆãƒ†ã‚¹ãƒˆ
5. **API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: OpenAPI/Swagger ã«ã‚ˆã‚‹ API ä»•æ§˜æ›¸
6. **ãƒ­ã‚®ãƒ³ã‚°**: Python logging ã§ æ“ä½œãƒ­ã‚°è¨˜éŒ²
7. **ç›£è¦–**: Prometheus ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°

---

**æ›´æ–°æ—¥**: 2026-01-31
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ– Phase 3
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… ãƒ†ã‚¹ãƒˆæ¸ˆã¿ãƒ»æœ¬ç•ªç’°å¢ƒå¯¾å¿œå¯
